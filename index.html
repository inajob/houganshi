<html>
    <head>
        <style>
            html, body{
                margin: 0;
                padding: 0;
            }
            .cursor{
                position:absolute;
                top:0px;
                left:0px;
                background-color: rgba(255,255,255, 0.1);
                border: none;
                outline:none;
                width: 100px;
                height: 20px;
            }
            #source{
                width:100%;
                height:300px;
            }
        </style>
        <script>
            let cursorElm = document.createElement("input")
            let data = [];
            let cursorX = 0;
            let cursorY = 0;

            // === API ===
            let setCursor = (x,y) => {
                cursorElm.style.top = y * 20
                cursorElm.style.left = x * 16
                cursorElm.focus()
                cursorX = x;
                cursorY = y;
            }
            let setChar = (x, y, c) => {
                data[y][x].innerHTML = c
            }
            let getChar = (x,y) => {
                return data[y][x].innerHTML
            }
            // === Event ===
            let onClick = (x, y) => {
                setCursor(x, y)
            }
            let onInput = (s) => {
                for(let i = 0; i < s.length; i ++){
                    setChar(cursorX, cursorY, s[i])
                    setCursor(cursorX + 1 ,cursorY)
                }
            }
            let onKeyDown = (k) => {
                switch(k){
                        case "Enter":
                            while(cursorX > 0){
                                if(cursorX == 0 || getChar(cursorX - 1, cursorY) == ""){
                                    break;
                                }
                                setCursor(cursorX - 1, cursorY)
                            }
                            setCursor(cursorX, cursorY + 1)
                            break;
                        case "ArrowDown":
                            setCursor(cursorX, cursorY + 1)
                            break;
                        case "ArrowLeft":
                            setCursor(cursorX - 1, cursorY )
                            break;
                        case "ArrowRight":
                            setCursor(cursorX + 1, cursorY )
                            break;
                        case "ArrowUp":
                            setCursor(cursorX, cursorY - 1)
                            break;
                        case "Backspace":
                            setCursor(cursorX - 1, cursorY )
                            setChar(cursorX, cursorY, "")
                            break;
                    }
            }
            // ============

            window.addEventListener("load", (e) => {
                let main = document.getElementById("main")
                for(let i = 0; i < 25; i ++){
                    let line = document.createElement("div")
                    let lineElms = []
                    line.style.display = "flex"
                    for(let j = 0; j < 50; j ++){
                        let elm = document.createElement("div")
                        elm.style.flexShrink = "0"
                        elm.style.flexBasis = "16px"
                        elm.style.height = "20px"
                        elm.style.backgroundColor = "#ddf"
                        elm.style.outline = "solid 1px #eef"
                        elm.innerHTML = ""
                        elm.dataset.x = j
                        elm.dataset.y = i
                        line.appendChild(elm)
                        lineElms.push(elm)
                    }
                    main.appendChild(line)
                    data.push(lineElms)
                }
                cursorElm.type = "text"
                cursorElm.className = "cursor"
                main.appendChild(cursorElm)

                let isCompotision = false
                let decideInputs = () => {
                    let value = cursorElm.value
                    onInput(value)
                    cursorElm.value = ""
                }
                cursorElm.addEventListener("compositionstart", (e) => {
                    isCompotision = true
                })
                cursorElm.addEventListener("compositionend", (e) => {
                    isCompotision = false
                    decideInputs()
                })
                cursorElm.addEventListener("keydown", (e) => {
                    console.log(e.key)
                    switch(e.key){
                        case "Enter":
                        case "ArrowDown":
                        case "ArrowLeft":
                        case "ArrowRight":
                        case "ArrowUp":
                            onKeyDown(e.key)
                            break;
                        case "Backspace":
                            if(!isCompotision){
                                onKeyDown(e.key)
                            }
                            break;
                    }
                })
                cursorElm.addEventListener("input", (e) => {
                    if(!isCompotision){
                        decideInputs()
                    }
                })

                let touch = (e) => {
                    console.log(e.target)
                    let x = parseInt(e.target.dataset.x)
                    let y = parseInt(e.target.dataset.y)
                    onClick(x, y)
                }
                if('ontouchstart' in document.documentElement){
                    main.addEventListener("touchstart", (e) => {
                        touch(e)
                    }, true)
                }else{
                    main.addEventListener("click", (e) => {
                        touch(e)
                    }, true)
                }
            })
        </script>
    </head>
    <body>
        <div id="main"></div>
        <div>
        Source: <a href="https://github.com/inajob/houganshi">https://github.com/inajob/houganshi</a>
        </div>
    </body>
</html>
